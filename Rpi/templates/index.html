<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>BirdsNest Images</title>
<style>
body { font-family: Arial; margin: 20px; background:#f5f5f5; color:#333; }
h1{text-align:center;}
.controls{ text-align:center; margin-bottom:20px; }
.controls input, .controls select{ padding:5px 10px; margin:0 5px; font-size:14px; }

.gallery{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-top:10px;}
.card{ background:white; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; cursor:pointer; }
.card img{ max-width:100%; border-radius:8px; transition:transform 0.2s; }
.card img:hover{ transform:scale(1.05); }
.filename{ font-size:14px; color:#666; margin-top:8px; }

/* Lightbox */
.lightbox{ position:fixed; display:none; flex-direction:column; justify-content:center; align-items:center; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index:999; }
.lightbox-main{ max-width:90%; max-height:80%; position:relative; overflow:hidden; }
.lightbox-main img{ max-width:100%; max-height:100% ;width:auto; height:auto; cursor:grab; user-select:none; transition:transform 0.2s; }
.lightbox-thumbnails{ display:flex; gap:5px; margin-top:10px; overflow-x:auto; max-width:90%; }
.lightbox-thumbnails img{ height:60px; border-radius:4px; cursor:pointer; opacity:0.7; transition:opacity 0.2s; }
.lightbox-thumbnails img.active{ opacity:1; border:2px solid #fff; }
.lightbox .close{ position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer; z-index:1000; }
.lightbox .nav-arrow{ position:absolute; top:50%; font-size:50px; color:white; cursor:pointer; z-index:1000; user-select:none; padding:0 10px; transform:translateY(-50%);}
.lightbox .nav-left{ left:10px; }
.lightbox .nav-right{ right:10px; }
</style>
</head>
<body>

<h1>ðŸ“· BirdsNest Images</h1>

<div class="controls">
    <input type="text" class="filter-input" placeholder="Filtrer par nom...">
    <select class="sort-select">
        <option value="desc">Newest first</option>
        <option value="asc">Oldest first</option>
    </select>
</div>

<div class="gallery">
{% for f in files %}
<div class="card" data-filename="{{ f.name }}" data-time="{{ f.time }}">
    <img src="/thumbs/{{ f.name }}" data-full="/images/{{ f.name }}" alt="{{ f.name }}" loading="lazy">
    <div class="filename">{{ f.name }}</div>
</div>
{% endfor %}
</div>

<div class="lightbox">
    <span class="close">&times;</span>
    <span class="nav-arrow nav-left">&#10094;</span>
    <span class="nav-arrow nav-right">&#10095;</span>
    <div class="lightbox-main">
        <img src="">
    </div>
    <div class="lightbox-thumbnails"></div>
</div>

<script>
const gallery = document.querySelector('.gallery');
const filterInput = document.querySelector('.filter-input');
const sortSelect = document.querySelector('.sort-select');
const lightbox = document.querySelector('.lightbox');
const lightboxImg = lightbox.querySelector('.lightbox-main img');
const thumbnailsContainer = lightbox.querySelector('.lightbox-thumbnails');
const closeBtn = lightbox.querySelector('.close');
const prevBtn = lightbox.querySelector('.nav-left');
const nextBtn = lightbox.querySelector('.nav-right');

let allImages=[], allThumbs=[], allTimes=[], currentIndex=0;

function initGallery(){
    // Clear arrays and thumbnails
    allImages = [];
    allThumbs = [];
    allTimes = [];
    thumbnailsContainer.innerHTML = "";

    gallery.querySelectorAll('.card').forEach((card,idx)=>{
        const img=card.querySelector('img');
        const full=img.dataset.full;
        const thumb=img.src;
        const time=parseFloat(card.dataset.time);

        allImages.push(full);
        allThumbs.push(thumb);
        allTimes.push(time);

        const tImg=document.createElement('img');
        tImg.src=thumb; tImg.dataset.full=full;
        if(idx===0) tImg.classList.add('active');
        tImg.addEventListener('click', ()=>{
            currentIndex=allImages.indexOf(tImg.dataset.full); showImage(); lightbox.style.display='flex'; resetZoom();
        });
        thumbnailsContainer.appendChild(tImg);

        img.addEventListener('click', ()=>{
            currentIndex=allImages.indexOf(full); showImage(); lightbox.style.display='flex'; resetZoom();
        });
    });
}

function showImage(){
    lightboxImg.src = allImages[currentIndex];
    const thumbs = thumbnailsContainer.querySelectorAll('img');
    thumbs.forEach((t,i)=> t.classList.toggle('active', i===currentIndex));
    const activeThumb = thumbs[currentIndex];
    if(activeThumb){
        const containerWidth = thumbnailsContainer.offsetWidth;
        const thumbWidth = activeThumb.offsetWidth;
        const scrollLeft = activeThumb.offsetLeft - containerWidth/2 + thumbWidth/2;
        thumbnailsContainer.scrollTo({ left: scrollLeft, behavior:'smooth' });
    }
}

function closeLightbox(){ lightbox.style.display='none'; resetZoom(); }

function prevImage(){ currentIndex=(currentIndex-1+allImages.length)%allImages.length; showImage(); }
function nextImage(){ currentIndex=(currentIndex+1)%allImages.length; showImage(); }

closeBtn.addEventListener('click', closeLightbox);
prevBtn.addEventListener('click', prevImage);
nextBtn.addEventListener('click', nextImage);

// Zoom & pan
let scale=1, originX=0, originY=0, startX=0, startY=0, dragging=false;
function resetZoom(){ scale=1; originX=0; originY=0; lightboxImg.style.transform='none'; }
lightboxImg.addEventListener('wheel', e=>{ e.preventDefault(); scale+=e.deltaY*-0.001; scale=Math.min(Math.max(1,scale),5); lightboxImg.style.transform=`scale(${scale}) translate(${originX}px, ${originY}px)`; });
lightboxImg.addEventListener('pointerdown', e=>{ dragging=true; startX=e.clientX-originX; startY=e.clientY-originY; lightboxImg.style.cursor='grabbing'; });
lightboxImg.addEventListener('pointermove', e=>{ if(!dragging) return; originX=e.clientX-startX; originY=e.clientY-startY; lightboxImg.style.transform=`scale(${scale}) translate(${originX}px, ${originY}px)`; });
lightboxImg.addEventListener('pointerup', e=>dragging=false);
lightboxImg.addEventListener('pointerleave', e=>dragging=false);

// Filter
filterInput.addEventListener('input', e=>{
    const term=e.target.value.toLowerCase();
    gallery.querySelectorAll('.card').forEach(card=>{
        card.style.display=card.dataset.filename.toLowerCase().includes(term)?'block':'none';
    });
});

// Sort by age
sortSelect.addEventListener('change', e=>{
    const order=e.target.value;
    const cards=Array.from(gallery.children);
    cards.sort((a,b)=>{
        const tA=parseFloat(a.dataset.time);
        const tB=parseFloat(b.dataset.time);
        return order==='asc'? tA-tB : tB-tA;
    });
    cards.forEach(c=>gallery.appendChild(c));
});

initGallery();
</script>

</body>
</html>
